# ARQ超时重传机制
ARQ超时重传机制保证了数据的正确到达，ARQ协议包含`等待ARQ`和`连续ARQ`

## 停止等待ARQ

### 正常传输过程

只要A向B发送一段报文，都要停止发送并启动一个定时器，等待对端回应，如果在定时器时间内接收到应答就清除定时器，并发送下一段报文

### 报文丢失或者错误

在报文传输过程中可能会出现`丢包`,这时候超时定时器设定的时间就会再次发送丢包的数据直到对端相应，所以每次发送之前都需要备份数据

即使报文最后能正常传送到对端，也可能在传输过程中存在报文出错的问题，这时候对端会抛弃该报文，并重传

PS:一般定时器设定的时间都会大于一个RTT的平均时间，（RTT指的是往返时延，在计算机网络中是一个重要的指标，表示从发送端发送数据开始，到发送端收到来自接收端对确认，总共经历的时延，`RTT=2*Tp+Tb;Tp为传播时延；Tb为确认信号时间`）

### ACK超时或丢失

对端传输的应答也可能出现丢失或超时的情况，那么超过定时器时间A照样会重传报文。这时候B端收到相同序号的报文回丢弃报文并重传应答，知道A端重新发送下一个序号的报文。

在超时的情况下可能出现应答很迟到达，这时候A端会判断该序号是否已经接收过，如果接受过，只需丢弃应答即可

`这个协议的缺点就是传输效率低，在良好的网络环境下都得得带对端的ACk`

## 连续ARQ

连续ARQ中，发送端拥有一个发送窗口，可以在没有收到应答的情况下持续发送窗口内的数据，这样相比停止等待ARQ来说减少了等待时间，提高了效率

### 累计确认
连续ARQ中，接收端会持续不断收到报文，如果和停止等待ARQ中接受一个报文就发送一个应答一样，就太浪费资源了，通过累计确认，可以在收到多个报文以后统一回复一个应答报文。报文重的ACk可以用来告诉发送端这个序号之前的数据已经接收到了，下次请发送这个序号+1的数据

累计确认也有一个弊端在连续接受报文的时候，5，7已经接收到，但是未接收到序号6的报文，这时候ACK只能回复6,这样会早场发送端重复发送数据，这种情况可以通过SACK来解决


## 滑动窗口

### 发送窗口

发送端窗口包含已发送但未收到应答的数据和可以发送但是未发送的数据，用来对发送端进行流量控制，而发送窗口的大小就代表还没有收到对方确认信息的情况下发送端最多可以连续发送的个数
![](https://user-gold-cdn.xitu.io/2018/5/5/1632f25c587ffd54?w=660&h=270&f=png&s=37109)

## 接收窗口

其大小WR可以代表连续接收的最多数据个数，窗内是当前欲接受的数据的发送序号（只有序号在窗口内的数据才可以接受，否则丢弃，并且接受窗口驱动发送窗口的驱动,发送端窗口是根据窗口剩余大小决定的，接受方会把当前接收窗口的剩余大小写入应答报文，发送端收到应答后根据该值和当前网络阻塞情况设置发送窗口的大小，所以发送端的窗口是不断变化的

![](https://user-gold-cdn.xitu.io/2018/5/5/1632f25cca99c8f4?w=660&h=210&f=png&s=24554)

