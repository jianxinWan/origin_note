# DNS 解析

## 域名和 IP 地址并用的理由

TCP/IP 网络是通过 IP 地址来确定通信对象的，不知道 IP 地址就无法将消息发送给对方，因此，在委托操作系统发送消息时，必须要先查询好对方 的 IP 地址。

TIP:如果 Web 服务器使用了虚拟主机功能,有可能无法通过 IP 地址来访问。因为虚拟主机是寄存在服务器上的一个或多个没有实体的服务器，访问虚拟主机的域名的时候，先根据DNS解析的IP访问到实体主机，然后实体主机再根据域名把连接转发给对应的虚拟主机，DNS解析的IP只是实体主机的IP（并不是要访问的web应用服务器IP地址）。

## DNS解析的过程

- 系统会检查浏览器缓存中有没有这个域名对应的解析过的ip地址，如果缓存中有，这个解析过程就将结束。浏览器中的缓存是通过这个域名的失效时间和空间大小控制的。
- 如果用户的浏览器缓存中没有，浏览器会查找操作系统缓存中，即为本地的host文件。
- 如果本地的host文件中没有，那么操作系统就会把这个域名发送给LocalDNS，也就是本地的域名服务器。这个DNS通常都提供本地互联网中接入的一个DNS解析服务。这个专门的域名解析服务器的性能都会很好，他们一般都会缓存域名的解析结果，当然缓存时间是受域名的失效时间控制的，一般缓存空间不是影响域名失效的主要因素。一般90%的域名解析到这里就结束了，所以LocalDNS主要承担了域名的解析工作。

`DNS服务器中的所有信息都是按照域名以分层的结构来保存的，层次通过点号来划分：主机名.次级域名.顶级域名.根域名.`越靠右层级越高，所有域名后面都是带有根域名的，但是后面的一般都省略掉了。

![域名解析](https://pic1.zhimg.com/80/v2-dd550d1841c9c5b78327720dadc76934_hd.jpg)

`运营商发起的迭代请求过成`

- 如果LocalDNS仍然没有命中，就直接到root Server域名服务器请求解析。
- 根域名服务器返回给本地域名服务器一个所查询的主域名服务器的地址(.com,.cn.org)。
- 本地域名服务器再向上一步主域名服务器地址发送请求
- 接收主域名服务器的返回的地址，查找返回此域名对应的Nanme Server域名服务器的地址，这个Name Server通常就是我们注册的域名。例如我们在某个域名服务器提供商申请的域名，那么这个域名解析任务就是由这个域名提供的服务器来完成。
- Name Sever域名服务器会查询存储的域名和ip映射关系表，正常情况下都根据域名得到目标的ip记录，连同一个TTL值返回DNS域名服务器。
- 返回域名对应的ip和TTL值，Local DNS server会缓存这个域名和ip的对应关系，缓存时间由TTL的值来控制。
- 把解析的结果返回给用户，用户根据TTL值在本地系统缓存中，域名解析过程结束。

![迭代请求与解析](https://pic3.zhimg.com/v2-b953368d26fffb256ca0c4ad0704c922_r.jpg)

## HTTP劫持

### DNS劫持

![劫持流程](https://user-gold-cdn.xitu.io/2017/9/14/eadef534e6c4347b6e2e6feb91e97b89?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

DNS劫持又称域名劫持，是指在劫持的网络范围内拦截域名解析的请求，分析请求的域名，把审查范围以外的请求放行，否则返回假的IP地址或者什么都不做使请求失去响应，其效果就是对特定的网络不能访问或访问的是假网址。其实本质就是对DNS解析服务器做手脚，或者是使用伪造的DNS解析服务器可以通过下图来展示

#### 解决办法

DNS的劫持过程是通过攻击运营商的解析服务器来达到目的。我们可以不用运营商的DNS解析而使用自己的解析服务器或者是提前在自己的App中将解析好的域名以IP的形式发出去就可以绕过运营商DNS解析，这样一来也避免了DNS劫持的问题。

### 内容劫持

![内容劫持](https://user-gold-cdn.xitu.io/2017/9/14/6216c715bb9f605d7c2c7f1577a2afb4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

内容劫持网上很少有提到，这也是在做httpDNS SDK所遇到的一个问题，其实内容劫持一开始的出发点是好的，是运营商为了加快用户的访问速度同时减少自己的流量损耗而做的一个缓存机制，用户在像服务器请求数据的时候运营商会把用户的请求转移到这个缓存池中，如果缓存中有就直接返回，没有的话再去像服务器请求然后拦截并缓存服务端给用户的回调数据，这样一来可以极大的降低运营商像服务器请求的次数，也能加快用户的访问，所以出发点是好，但是一些非法的商家对`缓存池内部做一次些处理就是直接对返回的内容进行修改`，这样一来我们就会接受到错误的数据
